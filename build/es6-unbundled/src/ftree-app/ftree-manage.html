<html><head><link rel="import" href="../../bower_components/polymer/polymer-element.html"><link rel="import" href="../../bower_components/polymer/lib/elements/dom-if.html"><link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html"><link rel="import" href="../../bower_components/paper-button/paper-button.html"><link rel="import" href="../../bower_components/paper-styles/color.html"><link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html"><link rel="import" href="../../bower_components/iron-form/iron-form.html"><link rel="import" href="../../bower_components/iron-icons/maps-icons.html"><link rel="import" href="../../bower_components/iron-icon/iron-icon.html"><link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html"><link rel="import" href="./ftree-member.html"><link rel="import" href="./ftree-form.html"><link rel="import" href="./setpublic-form.html"></head><body><dom-module id="ftree-manage"><template strip-whitespace=""><style>:host{display:block;}paper-button{border-color:#FDF3E7;border-style:solid;color:white;}.header{background-color:#339ACC;border-radius:5px;display:inline-block;padding:10px;padding-right:75px;position:relative;-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}.header>img{position:absolute;top:-3px;right:15px;height:50px;width:auto;}addftree-member{height:0px;overflow:hidden;}#ftreeholder{white-space:nowrap;overflow:visible;padding:0 auto;}.load-ani{transition:opacity 0.5s ease;}</style><h2 class="header" id="header" style="margin:2%"><span id="headerlink" style="margin:0px;padding:0px">Family Tree</span> <img src="/src/ftree-app/icon/tree.png"></h2><br><span id="isload" class="load-ani" style="display:none;opacity:1"><template is="dom-if" if="[[canedit]]"><template is="dom-if" if="[[!showfamily(ftree,me)]]"><paper-button style="margin:2%" on-click="createfamilyftree"><b>create New Family Tree</b></paper-button></template></template><div id="ftreeholder"></div></span><ftree-form id="ftreeform" users="[[users]]" canedit="[[canedit]]" eele="[[geteventele()]]"></ftree-form><span id="isnotload" class="load-ani" style="display:inline;position:relative;opacity:1"><img src="/src/ftree-app/icon/loading.png" style="margin:0px;width:auto;height:50vh"></span></template><script>class FtreeManage extends Polymer.Element{static get is(){return'ftree-manage'}static get properties(){return{prop1:{type:String,value:'ftree-app'},nav:{type:Object,value:function(){return{}}},users:{type:Object,value:null},pageid:{type:String,value:null,observer:'_pageidob'},canedit:{type:Boolean,value:!1},ftree:{type:Object,value:function(){return{}}},mypublicid:{type:Object,value:null},ftreep:String,database:{type:Object,readonly:!0,value:function(){return firebase.database()}},me:{type:String}}}_pageidob(a){var b=!1;null==a||!1==a?this.users&&(b=!0):null!=this.users&&this.users.uid==a&&(b=!0),this.canedit=b}ready(){super.ready();var a=this;a.$.headerlink.onclick=function(){window.location='/'},a.createdbyuser(a.pageid)}detached(){self.database.ref(self.ftreep).off()}constructor(){super(),this._updateself=this._updateselfE.bind(this),this._addchild=this._addchildE.bind(this),this._addparent=this._addparentE.bind(this),this._deletefire=this._deletefireE.bind(this),this._showmember=this._showmemberE.bind(this),this._setpublic=this._setpublicE.bind(this)}connectedCallback(){super.connectedCallback();var a=this,b=a.geteventele();b.addEventListener('updateself',a._updateself),b.addEventListener('addchild',a._addchild),b.addEventListener('addparent',a._addparent),b.addEventListener('deletefire',a._deletefire),b.addEventListener('showmember',a._showmember),b.addEventListener('setpublic',a._setpublic)}disconnectedCallback(){super.disconnectedCallback();var a=this,b=a.geteventele();b.removeEventListener('updateself',a._updateself),b.removeEventListener('addchild',a._addchild),b.removeEventListener('addparent',a._addparent),b.removeEventListener('deletefire',a._deletefire),b.removeEventListener('showmember',a._showmember),b.removeEventListener('setpublic',a._setpublic)}createfamilyftree(){var a=this,b=a.database.ref('ftree/users/'+this.users.uid).push().key,c={};c['ftree/users/'+this.users.uid+'/ftree/'+b]={name:a.users.displayName,p:'--',c:null,date:firebase.database.ServerValue.TIMESTAMP},c['ftree/users/'+this.users.uid+'/ftree/root']={rootid:b},a.database.ref().update(c)}setpublic(a){var b=this,c=['Public','Private'],d=a.currentTarget.innerHTML.trim();if(!0==a.detail.value&&(a.currentTarget.innerHTML=c[0]),!1==a.detail.value&&(a.currentTarget.innerHTML=c[1]),''==d||null==b.mypublicid)return!1;var e=new CustomEvent('setpublic',{detail:a.detail.value});window.dispatchEvent(e)}showfamily(a,b){if('object'!=typeof a||null==a)return!1;var c=Object.keys(a);return!!(0<=c.indexOf(b))}ftreeinterface(){return{name:'--',p:'--',c:'--',date:firebase.database.ServerValue.TIMESTAMP}}gettrue(){return!0}ownpage(){return!0}getpublicpath(){return'ftree/public/'}geteventele(){return this}createdbyuser(a){var b,c=this,d=c.$.ftreeholder;b=null==a||!1==a?c.users.uid:a,c.ftreep='ftree/users/'+b+'/ftree',c.database.ref(c.ftreep).on('value',function(e){if(c.$.isnotload.style.opacity='0',null==e.val())return d.innerHTML='',c.ftree=null,(null==a||!1==a)&&(window.location.hash=''),!1;(null==a||!1==a)&&(window.location.hash='pageid='+b),c.me=e.val().root.rootid.toString();var f=e.val();c.ftree=f,delete f.root,d.innerHTML='';var g=document.createElement('ftree-member');g.id='ctree',g.member=c.ftree,g.me=c.me,g.users=c.users,g.eele=c.geteventele(),d.appendChild(g)}),c.$.isnotload.addEventListener('transitionend',function(a){var b=a.currentTarget;b.style.display='none',c.$.isload.style.display='inline'})}_updateselfE(a){var b=this,c=b.$.ftreeform;if(null==c)return!1;var e=a.detail,d={},f=Object.keys(e);if(0<f.length){var g=b.ftreep+'/'+f[0];d[g]=e[f[0]],firebase.database().ref().update(d).then(function(){c.appear=!1})}}_addchildE(a){var b=this,c=b.$.ftreeform;if(null==c)return!1;var e=a.detail.data,d=a.detail.parent,f=Object.keys(e),g=firebase.database().ref(b.ftreep).push().key,h={};e.p=d,e.c=null,e.date=firebase.database.ServerValue.TIMESTAMP,h[b.ftreep+'/'+g]=e,h[b.ftreep+'/'+d+'/c/'+g]=g,firebase.database().ref().update(h).then(function(){c.appear=!1})}_addparentE(a){var b=this,c=b.$.ftreeform;if(null==c)return!1;var e=a.detail.data,d=a.detail.parent,f=Object.keys(e),g=b.ftree[d].p,h=firebase.database().ref(b.ftreep).push().key,i={};e.p=g,e.c={},e.c[d]=d,e.date=firebase.database.ServerValue.TIMESTAMP,d==b.me?(i[b.ftreep+'/root']={rootid:h},e.p='--'):(i[b.ftreep+'/'+g+'/c/'+h]=h,i[b.ftreep+'/'+g+'/c/'+d]=null),i[b.ftreep+'/'+h]=e,i[b.ftreep+'/'+d+'/p']=h,firebase.database().ref().update(i).then(function(){c.appear=!1})}_deletefireE(a){function b(a,d,e,f){var a=a,d=d,e=e,f=f;if('undefined'!=typeof d&&d.hasOwnProperty('c'))for(var g in d.c)e[c.ftreep+'/'+g]=null,f.push(g);if(0<f.length){var h=f.pop();b(a,a[h],e,f)}return e}var c=this,e=c.$.ftreeform;if(null==e)return!1;var f=a.detail,g={};if(c.me!=f){g[c.ftreep+'/'+f]=null;var d=c.ftree[f].p;g[c.ftreep+'/'+d+'/c/'+f]=null,g=b(c.ftree,c.ftree[f],g,[])}else g[c.ftreep]=null;return{}!=g&&void firebase.database().ref().update(g).then(function(){e.appear=!1})}_showmemberE(a){var b=this,c=b.$.ftreeform;if(null==c)return!1;var c=b.$.ftreeform;return null!=c&&void(c.parentele=a.detail,c.formdata=b.ftree[a.detail.getAttribute('parent')],c.meid=a.detail.getAttribute('parent'),c.appearcb={},c.appearcb.action=function(a){b.$.isload.style.display=a?'none':'block'},c.appear=!0)}_setpublicE(a){var b=this,c=b.$.ftreeform;if(null==c)return!1;var e=b.getpublicpath();if(!e)return!1;var f=firebase.database().ref(e).push().key,g={},d=[];null!=b.mypublicid&&(d=Object.keys(b.mypublicid));for(var h=0;h<d.length;h++)g[e+'/'+d[h]]=null;a.detail&&(g[e+'/'+f]={userid:b.users.uid}),firebase.database().ref().update(g)}}window.customElements.define(FtreeManage.is,FtreeManage);</script></dom-module></body></html>